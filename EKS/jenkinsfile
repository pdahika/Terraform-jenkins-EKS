pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID     = credentials('AWS_access_key_id')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_secret_access_key')
        AWS_DEFAULT_REGION    = "us-east-1"
    }

    stages {

        stage('checkout_scm') {
            steps {
                checkout scmGit(
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/pdahika/Terraform-jenkins-EKS.git'
                    ]]
                )
            }
        }

        stage('Verify Terraform') {
            steps {
                sh 'terraform version'
            }
        }

        stage('Terraform Init') {
            steps {
                dir('EKS') {
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Format') {
            steps {
                dir('EKS') {
                    sh 'terraform fmt'
                }
            }
        }

        stage('Terraform Validate') {
            steps {
                dir('EKS') {
                    sh 'terraform validate'
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                dir('EKS') {
                    sh 'terraform plan'
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('EKS') {
                    sh 'terraform apply --auto-approve'
                }
            }
        }

        stage('Deploy Nginx Application') {
            steps {
                dir('EKS/configuration_file') {
                    sh '''
                      aws eks update-kubeconfig \
                        --region us-east-1 \
                        --name my-eks-cluster

                      kubectl apply -f deployment.yaml
                      kubectl apply -f service.yaml
                    '''
                }
            }
        }
    }
}
